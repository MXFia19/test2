<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Twitch VOD Player</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.plyr.io/3.8.4/plyr.js"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.8.4/plyr.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
   <style>
        :root {
            --twitch-bg: #0e0e10;
            --twitch-surface: #18181b;
            --twitch-hover: #26262c;
            --twitch-purple: #9146ff;
            --twitch-text: #efeff1;
            --twitch-text-alt: #adadb8;
            --plyr-color-main: #9146ff;
            --plyr-control-radius: 4px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body { 
            background-color: var(--twitch-bg); 
            color: var(--twitch-text); 
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- NAVBAR STYLE TWITCH --- */
        .navbar {
            height: 50px;
            background: var(--twitch-surface);
            border-bottom: 1px solid #000;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            position: sticky; top: 0; z-index: 100;
        }

        .logo { font-weight: 700; color: var(--twitch-purple); font-size: 1.1rem; display: flex; align-items: center; gap: 5px; }
        
        .search-area {
            flex: 1;
            display: flex;
            justify-content: center;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .input-group {
            display: flex;
            width: 100%;
            background: #000;
            border-radius: 6px;
            border: 1px solid #3a3a3a; /* Bordure discr√®te */
            overflow: hidden;
            transition: 0.2s;
        }
        .input-group:focus-within { border-color: var(--twitch-purple); background: #000; }

        input[type="text"] {
            background: transparent;
            border: none;
            color: white;
            padding: 8px 12px;
            width: 100%;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .search-btn {
            background: #3a3a3a;
            border: none;
            padding: 0 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-btn:hover { background: #4a4a4a; }

        .lang-select {
            background: transparent;
            color: var(--twitch-text);
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        /* --- MAIN CONTENT --- */
        .main-container {
            flex: 1;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- TABS STYLE TWITCH --- */
        .tabs {
            display: flex;
            gap: 20px;
            border-bottom: 2px solid #26262c;
            margin-bottom: 10px;
        }
        .tab-btn {
            background: transparent;
            border: none;
            color: var(--twitch-text-alt);
            font-weight: 600;
            font-size: 0.95rem;
            padding: 10px 0;
            cursor: pointer;
            position: relative;
            transition: 0.2s;
        }
        .tab-btn:hover { color: var(--twitch-purple); }
        .tab-btn.active { color: var(--twitch-purple); }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: var(--twitch-purple);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- PLAYER AREA --- */
        #video-container {
            width: 100%;
            background: #000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none; /* Cach√© par d√©faut */
        }
        .plyr { 
            height: 100%; 
            border-radius: 0; 
            font-family: 'Inter', sans-serif;
        }

        /* --- INFO & STATUS --- */
        #status-msg { margin: 10px 0; font-weight: 600; font-size: 0.9rem; min-height: 20px; }
        .status-loading { color: #e6e619; } .status-success { color: #00ff88; } .status-error { color: #ff4f4d; }

        /* --- LIVE CARD (HEADER STREAMER) --- */
        .live-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: var(--twitch-surface);
            border-bottom: 1px solid #000;
            display: none; /* Cach√© par d√©faut */
        }
        .live-avatar { width: 64px; height: 64px; border-radius: 50%; border: 3px solid transparent; object-fit: cover; }
        .live-avatar.online { border-color: #e91916; }
        
        .live-meta { flex: 1; }
        .live-user { font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        .live-game { color: var(--twitch-purple); font-weight: 500; font-size: 0.9rem; }
        .live-badge { background: #e91916; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; }
        .offline-badge { background: #555; color: #ddd; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; }
        
        .live-preview { width: 280px; aspect-ratio: 16/9; border-radius: 6px; object-fit: cover; display: none; }

        /* --- VODS GRID --- */
        .vod-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            padding: 10px 0;
            display: none;
        }
        .vod-card {
            background: transparent;
            cursor: pointer;
            transition: 0.2s;
        }
        .vod-card:hover .vod-thumb-img { transform: translate(4px, -4px); box-shadow: -4px 4px 0 var(--twitch-purple); }
        
        .vod-thumb-box { position: relative; aspect-ratio: 16/9; margin-bottom: 8px; }
        .vod-thumb-img { width: 100%; height: 100%; object-fit: cover; transition: 0.2s; }
        .vod-duration { 
            position: absolute; bottom: 5px; right: 5px; 
            background: rgba(0,0,0,0.6); color: white; 
            font-size: 0.75rem; padding: 2px 4px; border-radius: 2px; 
        }
        
        .vod-title { font-weight: 600; font-size: 0.9rem; line-height: 1.4; color: var(--twitch-text); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .vod-date { font-size: 0.8rem; color: var(--twitch-text-alt); margin-top: 4px; }

        /* --- OPTIONS BAR --- */
        .options-bar {
            display: none;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            background: var(--twitch-surface);
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .btn-twitch {
            background: var(--twitch-hover);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-twitch:hover { background: #3a3a40; }
        .btn-primary { background: var(--twitch-purple); color: white; }
        .btn-primary:hover { background: #772ce8; }
        
        select {
            background: var(--twitch-bg);
            color: white;
            border: 1px solid #3a3a3a;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: 600;
        }

        #mobile-alert { display: none; padding: 10px; background: #2f2f35; margin: 10px; border-radius: 4px; font-size: 0.9rem; }
        @media (max-width: 600px) {
            .navbar { padding: 0 10px; gap: 10px; }
            .logo span { display: none; }
            .live-header { flex-direction: column; align-items: flex-start; }
            .live-preview { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="var(--twitch-purple)"><path d="M2.149 0L.537 4.119v16.836h5.731V24h3.224l3.045-3.045h4.657l6.269-6.269V0H2.149zm19.164 13.612l-3.582 3.582H12l-3.045 3.045v-3.045H4.119V2.149h17.194v11.463z"/><path d="M10.388 6.269h2.149v5.731h-2.149V6.269zm5.373 0h2.149v5.731h-2.149V6.269z"/></svg>
            <span>VOD Player</span>
        </div>

        <div class="search-area">
            <div class="input-group">
                <input type="text" id="searchInput" placeholder="Rechercher Streamer..." onkeydown="if(event.key==='Enter') doSearch()">
                <button class="search-btn" onclick="doSearch()">üîç</button>
            </div>
        </div>

        <select id="langSelect" class="lang-select" onchange="setLanguage(this.value)">
            <option value="fr">FR</option>
            <option value="en">EN</option>
            <option value="es">ES</option>
        </select>
    </div>

    <div id="mobile-alert" class="mobile-only">
        üì± <span data-lang="mobile_desc">Mobile? Utilisez VLC/Outplayer.</span>
    </div>

    <div id="liveHeader" class="live-header">
        </div>

    <div class="main-container">

        <div class="tabs">
            <button class="tab-btn" id="tab-channel" onclick="switchMode('channel')" data-lang="tab_streamer">Cha√Æne</button>
            <button class="tab-btn" id="tab-direct" onclick="switchMode('direct')" data-lang="tab_id">ID Vid√©o</button>
        </div>

        <div id="status-msg"></div>

        <div id="video-container">
            <video id="player" playsinline controls crossorigin></video>
        </div>

        <div id="options-bar" class="options-bar">
            <select id="qualitySelect" onchange="changeQuality()"></select>
            <button class="btn-twitch" onclick="togglePiP()" data-lang="btn_pip">üì∫ PiP</button>
            <button class="btn-twitch" onclick="downloadM3U8()" data-lang="btn_dl">üì• M3U8</button>
            <input type="text" id="vlcLink" readonly style="background:#000; border:none; color:#555; width: 10px; opacity:0;">
            <button class="btn-twitch" onclick="copyLink()" data-lang="btn_copy">üìã Copier Lien</button>
            <button class="btn-primary mobile-only" onclick="openInOutplayer()">Outplayer</button>
            <button class="btn-primary mobile-only" onclick="openInVLC_Mobile()">VLC</button>
        </div>

        <div id="vod-list" class="vod-grid"></div>

    </div>

    <script>
        const API_URL = "https://test2.kurzmathis4.workers.dev"; // VOTRE WORKER

        const translations = {
            fr: { tab_id: "ID Vid√©o", tab_streamer: "Cha√Æne", mobile_desc: "Mobile? Utilisez VLC ou Outplayer.", btn_pip: "Fen√™tre Flottante", btn_dl: "Fichier M3U", btn_copy: "Copier Lien", err_missing: "Nom manquant", loading: "Chargement...", live_on: "LIVE", offline: "HORS LIGNE", offline_msg: "Pas de stream en cours.", last_live: "Dernier live : ", no_vod: "Aucune VOD trouv√©e.", btn_watch_live: "Regarder le Live" },
            en: { tab_id: "Video ID", tab_streamer: "Channel", mobile_desc: "Mobile? Use VLC or Outplayer.", btn_pip: "PiP Mode", btn_dl: "M3U File", btn_copy: "Copy Link", err_missing: "Missing name", loading: "Loading...", live_on: "LIVE", offline: "OFFLINE", offline_msg: "Stream is offline.", last_live: "Last live: ", no_vod: "No VODs found.", btn_watch_live: "Watch Live" },
            es: { tab_id: "ID Video", tab_streamer: "Canal", mobile_desc: "¬øM√≥vil? Usa VLC o Outplayer.", btn_pip: "Modo PiP", btn_dl: "Archivo M3U", btn_copy: "Copiar Enlace", err_missing: "Falta nombre", loading: "Cargando...", live_on: "EN VIVO", offline: "OFFLINE", offline_msg: "No hay directo.", last_live: "√öltimo live: ", no_vod: "No hay VODs.", btn_watch_live: "Ver Directo" }
        };

        let currentLang = 'fr';
        let currentLinks = {};
        let hls = null;
        let player = null;
        let currentMode = 'channel';

        // Elements
        const el = {
            status: document.getElementById('status-msg'),
            vodList: document.getElementById('vod-list'),
            videoContainer: document.getElementById('video-container'),
            optionsBar: document.getElementById('options-bar'),
            qualitySelect: document.getElementById('qualitySelect'),
            vlcInput: document.getElementById('vlcLink'),
            liveHeader: document.getElementById('liveHeader'),
            searchInput: document.getElementById('searchInput'),
            tabChannel: document.getElementById('tab-channel'),
            tabDirect: document.getElementById('tab-direct')
        };

        document.addEventListener('DOMContentLoaded', () => {
            const userLang = navigator.language.slice(0, 2);
            setLanguage(translations[userLang] ? userLang : 'fr');
            
            player = new Plyr('#player', {
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'pip', 'fullscreen'],
                settings: ['speed']
            });

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('id')) { 
                el.searchInput.value = urlParams.get('id'); 
                switchMode('direct'); 
                doSearch(); 
            } else if (urlParams.get('channel')) { 
                el.searchInput.value = urlParams.get('channel'); 
                switchMode('channel'); 
                doSearch(); 
            } else {
                switchMode('channel');
            }

            if (/Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                document.querySelectorAll('.mobile-only').forEach(e => e.style.display = 'inline-block');
                document.getElementById('mobile-alert').style.display = 'block';
            }
        });

        function setLanguage(lang) {
            currentLang = lang;
            document.getElementById('langSelect').value = lang;
            document.querySelectorAll('[data-lang]').forEach(e => {
                const k = e.getAttribute('data-lang');
                if (translations[lang][k]) e.textContent = translations[lang][k];
            });
            el.searchInput.placeholder = lang === 'fr' ? "Rechercher Streamer..." : "Search Streamer...";
        }
        function txt(k) { return translations[currentLang][k] || k; }
        function setStatus(msg, type) { 
            el.status.textContent = translations[currentLang][msg] || msg; 
            el.status.className = type ? 'status-' + type : ''; 
        }

        function switchMode(mode) {
            currentMode = mode;
            el.tabChannel.classList.toggle('active', mode === 'channel');
            el.tabDirect.classList.toggle('active', mode === 'direct');
            el.searchInput.placeholder = mode === 'channel' ? (currentLang==='fr'?"Nom du Streamer":"Streamer Name") : (currentLang==='fr'?"ID de la VOD":"VOD ID");
            el.vodList.style.display = 'none';
            el.liveHeader.style.display = 'none';
        }

        function doSearch() {
            const val = el.searchInput.value.trim();
            if (!val) return;
            if (currentMode === 'channel') searchStreamer(val);
            else searchVodById(val);
        }

        // --- LOGIQUE CHA√éNE ---
        async function searchStreamer(name) {
            setStatus("loading", 'loading');
            el.vodList.style.display = 'none';
            el.liveHeader.style.display = 'none';
            hidePlayer();

            const pVods = fetch(`${API_URL}/api/get-channel-videos?name=${name}`);
            const pLive = fetch(`${API_URL}/api/get-live?name=${name}`);

            try {
                const [resVods, resLive] = await Promise.all([pVods, pLive]);
                const dataLive = await resLive.json();
                const dataVods = await resVods.json();

                const avatar = dataLive.avatar || dataVods.avatar || "https://static-cdn.jtvnw.net/user-default-pictures-uv/cdd517fe-def4-11e9-948e-784f43822e80-profile_image-70x70.png";
                
                // HEADER INFO
                el.liveHeader.style.display = 'flex';
                let html = '';
                
                if (!dataLive.error) {
                    // LIVE ON
                    html = `
                        <img src="${avatar}" class="live-avatar online">
                        <div class="live-meta">
                            <div class="live-user">${name} <span class="live-badge">${txt('live_on')}</span></div>
                            <div class="live-title">${dataLive.title}</div>
                            <div class="live-game">${dataLive.game}</div>
                            <button class="btn-primary" style="margin-top:8px" onclick="watchLive('${name}')">${txt('btn_watch_live')}</button>
                        </div>
                        ${dataLive.thumbnail ? `<img src="${dataLive.thumbnail.replace('{width}','320').replace('{height}','180')}" class="live-preview">` : ''}
                    `;
                } else {
                    // OFFLINE
                    let lastInfo = "";
                    if (!dataVods.error && dataVods.videos && dataVods.videos.length > 0) {
                        const lastDate = new Date(dataVods.videos[0].publishedAt).toLocaleDateString();
                        const timeSince = getTimeSince(dataVods.videos[0].publishedAt, dataVods.videos[0].lengthSeconds);
                        lastInfo = `<div style="font-size:0.85rem; color:#888; margin-top:4px;">${txt('last_live')} ${lastDate} (${timeSince})</div>`;
                    }
                    html = `
                        <img src="${avatar}" class="live-avatar">
                        <div class="live-meta">
                            <div class="live-user">${name} <span class="offline-badge">${txt('offline')}</span></div>
                            <div class="live-title" style="color:#777">${txt('offline_msg')}</div>
                            ${lastInfo}
                        </div>
                    `;
                }
                el.liveHeader.innerHTML = html;
                setStatus("");

                // VOD LIST
                if (!dataVods.error) {
                    el.vodList.innerHTML = '';
                    el.vodList.style.display = 'grid';
                    dataVods.videos.forEach(vod => {
                        const div = document.createElement('div');
                        div.className = 'vod-card';
                        div.onclick = () => { el.searchInput.value = vod.id; switchMode('direct'); searchVodById(vod.id); };
                        
                        const date = new Date(vod.publishedAt).toLocaleDateString();
                        const dur = Math.floor(vod.lengthSeconds / 60) + ' min';
                        
                        div.innerHTML = `
                            <div class="vod-thumb-box">
                                <img src="${vod.previewThumbnailURL}" class="vod-thumb-img">
                                <div class="vod-duration">${dur}</div>
                            </div>
                            <div class="vod-title">${vod.title}</div>
                            <div class="vod-date">${date}</div>
                        `;
                        el.vodList.appendChild(div);
                    });
                } else {
                    setStatus("no_vod", 'error');
                }

            } catch (e) { setStatus("err_network", 'error'); }
        }

        async function watchLive(name) {
            try {
                const res = await fetch(`${API_URL}/api/get-live?name=${name}`);
                const data = await res.json();
                if (data.error) return setStatus("offline_msg", 'error');
                setupPlayer(data.links);
            } catch (e) { setStatus("err_network", 'error'); }
        }

        async function searchVodById(id) {
            const cleanId = (id.match(/\d{8,}/) || [])[0];
            if (!cleanId) return setStatus("ID Invalide", 'error');
            
            setStatus("loading", 'loading');
            hidePlayer();
            
            try {
                const res = await fetch(`${API_URL}/api/get-m3u8?id=${cleanId}`);
                const data = await res.json();
                if (data.error) return setStatus(data.error, 'error');
                setupPlayer(data.links);
                setStatus("");
            } catch (e) { setStatus("err_network", 'error'); }
        }

        function setupPlayer(links) {
            currentLinks = links;
            el.qualitySelect.innerHTML = '';
            for (const [q, url] of Object.entries(links)) {
                const opt = document.createElement('option');
                opt.value = q;
                opt.textContent = q;
                el.qualitySelect.appendChild(opt);
            }
            el.videoContainer.style.display = 'block';
            el.optionsBar.style.display = 'flex';
            el.liveHeader.style.display = 'none'; // On cache le header quand on regarde
            changeQuality();
        }

        function changeQuality() {
            const url = currentLinks[el.qualitySelect.value];
            if (!url) return;
            el.vlcInput.value = url;
            
            if (Hls.isSupported()) {
                if (hls) hls.destroy();
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(document.getElementById('player'));
                hls.on(Hls.Events.MANIFEST_PARSED, () => player.play().catch(()=>{}));
            } else if (document.getElementById('player').canPlayType('application/vnd.apple.mpegurl')) {
                document.getElementById('player').src = url;
                player.play();
            }
        }

        function hidePlayer() {
            el.videoContainer.style.display = 'none';
            el.optionsBar.style.display = 'none';
            if (hls) hls.destroy();
            player.stop();
        }

        function getTimeSince(dateStr, durSec) {
            const end = new Date(new Date(dateStr).getTime() + durSec * 1000);
            const diff = new Date() - end;
            if (diff < 0) return "";
            const days = Math.floor(diff / 86400000);
            const hours = Math.floor(diff / 3600000);
            return days > 0 ? `${days}j` : `${hours}h`;
        }

        function togglePiP() { 
            const v = document.getElementById('player');
            if (document.pictureInPictureElement) document.exitPictureInPicture();
            else if (document.pictureInPictureEnabled) v.requestPictureInPicture();
        }
        function downloadM3U8() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([`#EXTM3U\n#EXTINF:-1,Twitch\n${el.vlcInput.value}`],{type:'audio/x-mpegurl'}));
            a.download = 'video.m3u'; a.click();
        }
        function copyLink() {
            el.vlcInput.select(); navigator.clipboard.writeText(el.vlcInput.value);
            alert("Lien copi√© !");
        }
        function openInVLC_Mobile() { window.location.href = 'vlc://' + el.vlcInput.value; }
        function openInOutplayer() { window.location.href = 'outplayer://' + el.vlcInput.value; }

    </script>
</body>
</html>
